<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Defect List</title>
    <link rel="stylesheet" href="trac.css">
    <link rel="stylesheet" href="code.css">
    <link rel="stylesheet" href="report.css">
    <style>
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination a {
            margin: 0 5px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            text-decoration: none;
            color: #333;
        }
        .pagination a.active {
            background-color: #007bff;
            color: white;
        }
        th {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>All Active Tickets</h1>
    <label for="itemsPerPage">Items per page:</label>
    <input type="number" id="itemsPerPage" value="20" min="1" onkeypress="if(event.key === 'Enter') changeItemsPerPage()">
    <button onclick="changeItemsPerPage()">Update</button>
    <table class="listing code" id="defectTable">
        <thead>
            <tr>
                <th onclick="sortTable('ID')">Ticket</th>
                <th onclick="sortTable('Summary')">Summary</th>
                <th onclick="sortTable('Component')">Component</th>
                <th onclick="sortTable('Version')">Version</th>
                <th onclick="sortTable('Milestone')">Milestone</th>
                <th onclick="sortTable('Type')">Type</th>
                <th onclick="sortTable('Severity')">Severity</th>
                <th onclick="sortTable('Owner')">Owner</th>
                <th onclick="sortTable('Status')">Status</th>
                <th onclick="sortTable('Time')">Created</th>
                <th onclick="sortTable('Changetime')">Changetime</th>
                <th onclick="sortTable('Reporter')">Reporter</th>
                <th onclick="sortTable('CC')">CC</th>
                <th onclick="sortTable('Keywords')">Keywords</th>
                <th onclick="sortTable('Resolution')">Resolution</th>
                <th onclick="sortTable('Project')">Project</th>
            </tr>
        </thead>
        <tbody id="defectTableBody">
            {% for defect in defects %}
            <tr>
                <td>#{{ defect.ID }}</td>
                <td>{{ defect.Summary }}</td>
                <td>{{ defect.Component }}</td>
                <td>{{ defect.Version }}</td>
                <td>{{ defect.Milestone }}</td>
                <td>{{ defect.Type }}</td>
                <td>{{ defect.Severity }}</td>
                <td>{{ defect.Owner }}</td>
                <td>{{ defect.Status }}</td>
                <td>{{ defect.Time }}</td>
                <td>{{ defect.Changetime }}</td>
                <td>{{ defect.Reporter }}</td>
                <td>{{ defect.CC | join(', ') }}</td>
                <td>{{ defect.Keywords | join(', ') }}</td>
                <td>{{ defect.Resolution }}</td>
                <td>{{ defect.Project }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="pagination" id="pagination"></div>
    <script>
        const defects = {{ defects|tojson }};
        let currentPage = 1;
        let itemsPerPage = 20;
        let sortOrder = {};
        const columns = ['ID', 'Summary', 'Component', 'Version', 'Milestone', 'Type', 'Severity', 'Owner', 'Status', 'Time', 'Changetime', 'Reporter', 'CC', 'Keywords', 'Resolution', 'Project'];

        function renderTable() {
            console.log('Rendering table');
            const tableBody = document.getElementById('defectTableBody');
            tableBody.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedItems = defects.slice(start, end);

            paginatedItems.forEach(defect => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${defect.ID}</td>
                    <td>${defect.Summary}</td>
                    <td>${defect.Component}</td>
                    <td>${defect.Version}</td>
                    <td>${defect.Milestone}</td>
                    <td>${defect.Type}</td>
                    <td>${defect.Severity}</td>
                    <td>${defect.Owner}</td>
                    <td>${defect.Status}</td>
                    <td>${defect.Time}</td>
                    <td>${defect.Changetime}</td>
                    <td>${defect.Reporter}</td>
                    <td>${defect.CC.join(', ')}</td>
                    <td>${defect.Keywords.join(', ')}</td>
                    <td>${defect.Resolution}</td>
                    <td>${defect.Project}</td>
                `;
                tableBody.appendChild(row);
            });

            renderPagination();
        }

        function renderPagination() {
            console.log('Rendering pagination');
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const pageCount = Math.ceil(defects.length / itemsPerPage);

            for (let i = 1; i <= pageCount; i++) {
                const pageLink = document.createElement('a');
                pageLink.href = '#';
                pageLink.innerText = i;
                if (i === currentPage) {
                    pageLink.classList.add('active');
                }
                pageLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderTable();
                });
                pagination.appendChild(pageLink);
            }
        }

        function changeItemsPerPage() {
            const input = document.getElementById('itemsPerPage');
            itemsPerPage = parseInt(input.value);
            if (isNaN(itemsPerPage) || itemsPerPage < 1) {
                itemsPerPage = 20; // Default value
                input.value = 20;
            }
            currentPage = 1;
            renderTable();
        }

        function sortTable(column) {
            if (!sortOrder[column]) {
                sortOrder[column] = 'asc';
            } else {
                sortOrder[column] = sortOrder[column] === 'asc' ? 'desc' : 'asc';
            }

            defects.sort((a, b) => {
                if (a[column] < b[column]) {
                    return sortOrder[column] === 'asc' ? -1 : 1;
                }
                if (a[column] > b[column]) {
                    return sortOrder[column] === 'asc' ? 1 : -1;
                }
                return 0;
            });

            renderTable();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed');
            renderTable();
        });
    </script>
</body>
</html>